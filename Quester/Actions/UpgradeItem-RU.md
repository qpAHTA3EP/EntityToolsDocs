# **UpgradeItem**

Команда предназначена для обработки (улучшения) предмета, заданного [*идентификатором*](#ref-ItemId "Опция 'ItemId'"), то есть повышение его ранга (уровня). <br/>
К таким предметам относятся волшебные камни и руны, знаки скакунов, артефактная экипировка и т. д.

## **Описание алгоритма**

1. В инвентаре персонажа производится поиск предмета, заданного комбинацией признаков.<br/>
   - По умолчанию производится поиск непривязанного предмета. Если нужно улучшить привязанный предмет, требуется установить флаги: [*AllowBoundToCharacter*](#ref-AllowBoundToCharacter) и/или [*AllowBoundToAccount*](#ref-AllowBoundToAccount). В этом случае приоритеты выставлены в следующем порядке:
      * непривязанный;
      * привязанный к аккаунту;
      * привязанный к персонажу.
   - При прочих равных для обработки будет выбран предмет, расположенный в ближайшей к началу ячейке инвентаря.
   - При поиске обрабатываемого предмета бот не может определить количество ранее произведенных попыток улучшения, поэтому этот параметр не учитывается.
2. Проводится поиск частицы [*Mote*](#ref-Mote), подлежащей использованию в процессе улучшения. Команда завершается, если необходимая частица в инвентаре отсутствует.
3. Проводится проверка наличия необходимых для улучшения компонентов (Очков обработки, камней усиления и т.п.). Если компонентов недостаточно, команда завершается.
4. Производится сопоставление списка необходимых для улучшения компонентов со списком подлежащих защите компонентов [*ProtectedCatalysts*](#ref-ProtectedCatalysts). Если для защиты требуемых компонентов не хватает страхующих катализаторов, команда завершается.
5. При наличии всех необходимых компонентов производится попытка улучшение предмета и команда завершается.

---

# **Настройки команды**

| **Наименование** | **Описание** 
|:-----------------|:-------------
||**Настройки идентификации предмета <br/>(категория "Item")**
|<a name ="ref-ItemId">***ItemId***</a> | Идентификатор предмета, который подлежит обработке.
|<a name ="ref-ItemIdType">***ItemIdType***</a> | Переключатель способа интерпретации [*ItemId*](#ref-ItemId):<br/>- ***Simple*** : Простая текстовая строка. <br/>В начале и в конце строки допускается использование символа подстановки ``"*"``, заменяющего произвольное число алфавитно-цифровых символов;<br/>- ***Regex*** : Регулярное выражение, составленное по правилам [*.Net Framework*](https://docs.microsoft.com/ru-ru/dotnet/standard/base-types/regular-expressions).
|<a name ="ref-AllowBoundToCharacter">***AllowBoundToCharacter***</a> | Флаг, позволяющий обрабатывать предмет, привязанный к персонажу.
|<a name ="ref-AllowBoundToAccount">***AllowBoundToAccount***</a> | Флаг, позволяющий обрабатывать предмет, привязанный к аккаунту.
||**Дополнительные настройки (Optional)**
|<a name ="ref-Forced">***Forced***</a> | Флаг, принудительного улучшения предмета, отключающий проверки возможности улучшения и наличия необходимых компонентов.<br/>Требуется для улучшения квестовых (обучающих) предметов, и первого улучшения некоторых предметов. Применять следует с осторожностью, так как может спровоцировать отключение игрового клиента от сервера или аварийное завершение программы.
|<a name ="ref-Mote">***Mote***</a> | Тип частицы, увеличивающей шанс успеха и подлежащей применению при улучшении.
|<a name ="ref-ProtectedCatalysts">***ProtectedCatalysts***</a> | Список идентификаторов компонентов, подлежащих защите страхующими катализаторами.

---

# **Завершение команды**

Команда завершается после выполнения попытки улучшения, независимо от достижения успеха (т.е. повышения ранга (уровня) предмета).

---

# **Аналоги**
Ближайшим аналогом является команда **RunUpgradeProfile**, реализованная в плагине [***QuesterAssistant***](https://www.neverwinter-bot.com/forums/viewtopic.php?f=155&t=8742). В отличие от неё команда **UpgradeItem**:
- по умолчанию не выполняет обработку привязанных предметов. Для их обработки требуется установить флаги [*AllowBoundToCharacter*](#ref-AllowBoundToCharacter) и/или [*AllowBoundToAccount*](#ref-AllowBoundToAccount);
- опция [*ForcedFeedingRPNumber*](#ref-ForcedFeedingRPNumber) позволяет настроить обработку предмета, информацию об обработке которого бот считывает некорректно (невалиден объект-описатель *ProgressionLogic*). Это необходимо для обработки некоторых квестовых предметов;
- выполняет поиск компонентов для обработки не только среди обычных предметов, но и в ценностях (*Numeric*). Кроме того, исправлена проверка компонентов при объединении осколков волшебных камней (невалиден объект-описатель *Catalyst.ItemDef*);
- проводится только одна попытка обработки предмета.

---

<a href="javascript:history.back()">Назад</a>  
[Назад к перечню команд](../EntityTools-QuesterExtensions-RU.md#ref-Actions)  
[Назад к содержанию](../../index.md)