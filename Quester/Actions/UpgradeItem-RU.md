# **UpgradeItem**

Команда предназначена для обработки (улучшения) предмета, заданного [*идентификатором*](#ref-ItemId), то есть повышение его ранга (уровня). <br/>
К таким предметам относятся волшебные камни и руны, знаки скакунов, артефактная экипировка и т. д.

## **Описание алгоритма**

1. В инвентаре персонажа производится поиск предмета, заданного комбинацией признаков.<br/>
   - По умолчанию производится поиск непривязанного предмета. Если нужно улучшить привязанный предмет, требуется установить флаги: [*AllowBoundToCharacter*](#ref-AllowBoundToCharacter) и/или [*AllowBoundToAccount*](#ref-AllowBoundToAccount). В этом случае приоритеты выставлены в следующем порядке: непривязанный, привязанный к аккаунту, привязанный к персонажу.
   - Кроме того, учитывается уровень заполнения предмета очками обработки (далее - ОО или RP) - из предметов с одинаковой привязкой выбирается предмет с наибольшим количеством ОО.
   - При прочих равных для обработки будет выбран предмет, расположенный в ближайшей к началу ячейке инвентаря.
   - При поиске обрабатываемого предмета бот не может определить количество ранее произведенных попыток улучшения, поэтому этот параметр не учитывается.
2. Найденный предмет заполняется очками обработки (ОО), если это необходимо.
   - Для большинства улучшаемых предметов количество ОО может быть вычислено автоматически. 
   - Для некоторых квестовых предметов вычислить необходимое количество ОО невозможно. В этом случае с помощью опции [ForcedFeedingRPNumber](#ref-ForcedFeedingRPNumber), можно указать количество очков обработки для принудительного заполнения такого предмета.
3. После заполнения предмета очками обработки, производится проверка наличия необходимых для улучшения компонентов (камней наложения чар, осколков усиления и т.п.).<br/> Если компонентов недостаточно - команда завершается.
4. При наличии всех необходимых компонентов производится улучшение предмета и команда завершается.

---

# **Настройки команды**

| **Наименование** | **Описание** 
|:-----------------|:-------------
||**Настройки идентификации предмета <br/>(категория "Item")**
|<a name ="ref-ItemId">***ItemId***</a> | Идентификатор предмета, который подлежит обработке.
|<a name ="ref-ItemIdType">***ItemIdType***</a> | Переключатель способа интерпретации [*ItemId*](#ref-ItemId):<br/>- ***Simple*** : Простая текстовая строка. <br/>В начале и в конце строки допускается использование символа подстановки ``"*"``, заменяющего произвольное число алфавитно-цифровых символов;<br/>- ***Regex*** : Регулярное выражение, составленное по правилам [.Net Framework](https://docs.microsoft.com/ru-ru/dotnet/standard/base-types/regular-expressions).
|<a name ="ref-AllowBoundToCharacter">***AllowBoundToCharacter***</a> | Флаг, позволяющий обрабатывать предмет, привязанный к персонажу.
|<a name ="ref-AllowBoundToAccount">***AllowBoundToAccount***</a> | Флаг, позволяющий обрабатывать предмет, привязанный к аккаунту.
||**Дополнительные настройки**
|<a name ="ref-ForcedFeedingRPNumber">***ForcedFeedingRPNumber***</a> | Количество очков обработки, для принудительного заполнения обрабатываемого предмета. <br/> Используется если количество очков обработки не удалось вычислить, т.к. у предмета не валидно свойство ProgressionLogic. <br/>Значение -1 отключает принудительное заполнение предмета очками обработки.
|<a name ="ref-Ward">***Ward***</a> | Переключатель типа катализатора, который должен быть использован при обработке: <br/> - ***Preservation*** : страхующий катализатор (зеленый), разрушающийся в случае неудачи, но сохраняющий ингридиенты.<br/> - ***Coalescent*** : полный катализатор, гарантирующий улучшение предмета с первой попытки. 

---

# **Завершение команды**

Команда завершается после выполнения попытки улучшения, независимо от достижения успеха (т.е. повышения ранга (уровня) предмета).

---

# **Аналоги**
Ближайшим аналогом является команда **RunUpgradeProfile**, реализованная в плагине [***QuesterAssistant***](https://www.neverwinter-bot.com/forums/viewtopic.php?f=155&t=8742). В отличие от неё команда **UpgradeItem**:
- по умолчанию не выполняет обработку привязанных предметов. Для их обработки требуется установить флаги [*AllowBoundToCharacter*](#ref-AllowBoundToCharacter) и/или [*AllowBoundToAccount*](#ref-AllowBoundToAccount);
- опция *ForceFeedingRPNumber* позволяет настроить обработку предмета, у которого невалидна *ProgressionLogic*. Это необходимо для обработки некоторых квестовых предметов;
- выполняет поиск компонентов для обработки не только среди обычных предметов, но и в ценностях (*Numeric*). Кроме того, исправлена проверка компонентов при объединении осколков волшебных камней (у которых не валидна *Catalyst.ItemDef*);
- проводится только одна попытка обработки предмета.

---

[**Вернуться к перечню команд**](../EntityTools-QuesterExtensions-RU.md)